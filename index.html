<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="manifest" href="?file=manifest">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      // Registrar el Service Worker con una URL dinámica
      navigator.serviceWorker.register('?file=sw', {scope: './'}).then(function(registration) {
        console.log('Service Worker registrado con éxito:', registration.scope);
      }, function(err) {
        console.log('Fallo al registrar el Service Worker:', err);
      });
    });
  }
</script>

  <style>
    /* Estilos para impresión */
    @media print {
      @page {
        size: auto;
        margin: 15mm;
      }
      body {
        margin: 0;
      }
    }

    /* Estilos para el pre-loader */
    #contenedor_carga {
      background-color: rgba(250, 240, 245, 0.9);
      height: 100%;
      width: 100%;
      position: fixed;
      transition: all 0.5s ease;
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #carga {
      border: 15px solid #ccc;
      border-top-color: #f4266a;
      border-top-style: groove;
      height: 100px;
      width: 100px;
      border-radius: 100%;
      animation: girar 1.5s linear infinite;
    }
    @keyframes girar {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    /* Mejoras para la tabla en móviles */
    .table-responsive {
      overflow-x: auto;
    }
    /* Estilos para la imagen y el título */
    .header-content {
      text-align: center;
      margin-bottom: 2rem;
    }
    .header-content img {
      max-width: 150px;
      height: auto;
    }
    /* Estilos para el botón de imprimir */
    .btn-print {
      margin-left: 10px;
    }
    /* ... (código CSS anterior) ... */

  </style>

  <script>
  let studentData = null;

  function preventFormSubmit() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      form.addEventListener('submit', event => event.preventDefault());
    });
  }
  window.addEventListener("load", preventFormSubmit, true); 

  function handleFormSubmit(formObject) {
    // Limpia los resultados anteriores
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('search-results2').innerHTML = '';
    studentData = null;

    // Ejecuta las dos búsquedas en paralelo
    google.script.run
      .withSuccessHandler(createTable)
      .processForm(formObject);
    google.script.run
      .withSuccessHandler(createTable2)
      .processForm2(formObject);
    
    document.getElementById("search-form").reset();
  }

  function createTable(dataArray) {
    const div = document.getElementById('search-results');
    if (dataArray && dataArray.length > 0) {
      // Guarda la información del estudiante
      studentData = studentData || {};
      studentData.info = dataArray[0];

      let result = `
        <table class="table table-sm table-striped caption-top">
          <caption>Información del estudiante</caption>
          <thead class="table-dark">
            <tr>
              <th scope="col">N. CÉDULA</th>
              <th scope="col">APELLIDOS Y NOMBRES</th>
              <th scope="col">PARALELO</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${dataArray[0][0]}</td>
              <td>${dataArray[0][1]}</td>
              <td>${dataArray[0][2]}</td>
            </tr>
          </tbody>
        </table>
      `;
      div.innerHTML = result; 
      Swal.fire({
        title: "¡Usuario encontrado!",
        icon: 'success',
      });
    } else {
      div.innerHTML = '';
      Swal.fire({
        title: "¡Usuario no encontrado!",
        text: "Vuelva a realizar la búsqueda",
        icon: 'error',
      });
    }
  }

  function createTable2(dataArray) {
    const div = document.getElementById('search-results2');
    if (dataArray && dataArray.length > 0) {
      // Guarda las calificaciones
      studentData = studentData || {};
      studentData.grades = dataArray;

      let result = `
        <table class="table table-sm table-striped table-bordered">
          <caption>Calificaciones por materia</caption>
          <thead>
            <tr class="table-primary">
              <th class="table-danger" scope="col">SEMESTRE</th>
              <th class="table-info" scope="col">MATERIA</th>
              <th scope="col">TAREAS</th>
              <th scope="col">ACT/PART.</th>
              <th scope="col">LECC.</th>
              <th scope="col">EVALUAC.</th>
              <th class="table-warning" scope="col">PROMEDIO</th>
              <th class="table-success" scope="col">CUALIFICACIÓN</th>
            </tr>
          </thead>
          <tbody>
      `;
      dataArray.forEach(row => {
        result += `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
      });
      result += `
          </tbody>
        </table>
      `;
      div.innerHTML = result; 
    } else {
      div.innerHTML = '';
    }
  }

  function imprimirPagina() {
    window.print();
  }

  // Nueva función para descargar el PDF
  function downloadPDF() {
    if (studentData && studentData.info && studentData.grades) {
      Swal.fire({
        title: "Generando PDF",
        text: "Por favor, espere...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      google.script.run
        .withSuccessHandler(pdfGenerationSuccess)
        .withFailureHandler(pdfGenerationFailure)
        .generatePdf(studentData);
    } else {
      Swal.fire({
        title: "No hay datos para generar el PDF",
        text: "Por favor, realice una búsqueda primero.",
        icon: "warning",
      });
    }
  }

  function pdfGenerationSuccess(pdfUrl) {
    Swal.close();
    if (pdfUrl) {
      window.open(pdfUrl, '_blank');
    } else {
      Swal.fire({
        title: "Error",
        text: "No se pudo obtener la URL del PDF.",
        icon: "error"
      });
    }
  }

  function pdfGenerationFailure(error) {
    Swal.close();
    Swal.fire({
      title: "Error al generar el PDF",
      text: error.message,
      icon: "error"
    });
  }

  window.onload = function() {
    document.getElementById('contenedor_carga').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('contenedor_carga').style.display = 'none';
    }, 500);
  };
</script>
</head>

<body>
  <div id="contenedor_carga">
    <div id="carga"></div>
  </div>

  <div class="container py-4">
    <div class="header-content">
      <img src="https://drive.google.com/thumbnail?id=1KB0VkLmFdaLf3dAyxflqwnsP1xPfEAtu" alt="Logo de la institución">
      <h1>Calificaciones Carpintería</h1>
    </div>

    <div class="row">
      <div class="col-12">
        <form id="search-form" class="row gx-2 gy-2 align-items-center" onsubmit="handleFormSubmit(this)">
          <div class="col-sm-auto">
            <label for="searchtext" class="col-form-label">Ingrese el número de cédula:</label>
          </div>
          <div class="col-sm-auto">
            <input type="text" class="form-control" id="searchtext" name="searchtext" placeholder="Ej: 1314567890">
          </div>
          <div class="col-sm-auto">
            <button type="submit" class="btn btn-primary">Buscar</button>
            <!--<button type="button" class="btn btn-secondary btn-print" onclick="imprimirPagina();">Imprimir</button> -->
            <button type="button" class="btn btn-success" onclick="downloadPDF();">Descargar PDF</button>
          </div>
        </form>
      </div>
    </div>

    <hr class="my-4">

    <div class="row">
      <div class="col-12">
        <div id="search-results" class="table-responsive mb-4">
          </div>
      </div>
      <div class="col-12">
        <div id="search-results2" class="table-responsive">
          </div>
      </div>
    </div>
  </div>
</body>
</html>
